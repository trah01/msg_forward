blueprint:
  name: çŸ­ä¿¡è½¬å‘å™¨ - éªŒè¯ç æå–é€šçŸ¥
  description: è‡ªåŠ¨æå–çŸ­ä¿¡ä¸­çš„éªŒè¯ç ï¼Œå¹¶å‘é€ä¼˜åŒ–åçš„é€šçŸ¥
  domain: automation
  
  input:
    sms_content_entity:
      name: çŸ­ä¿¡å†…å®¹ä¼ æ„Ÿå™¨
      description: é€‰æ‹©çŸ­ä¿¡è½¬å‘å™¨çš„"æœ€è¿‘çŸ­ä¿¡å†…å®¹"ä¼ æ„Ÿå™¨
      selector:
        entity:
          domain: sensor
    
    notify_service:
      name: é€šçŸ¥æœåŠ¡
      description: é€‰æ‹©è¦å‘é€é€šçŸ¥çš„æœåŠ¡
      selector:
        select:
          options:
            - notify.mobile_app_iphone
            - notify.persistent_notification
          custom_value: true
      default: "notify.mobile_app_iphone"

variables:
  sms_entity: !input sms_content_entity

trigger:
  - platform: state
    entity_id: !input sms_content_entity

condition:
  # å¿½ç•¥çŠ¶æ€å˜ä¸º unavailable/unknown çš„æƒ…å†µ
  - condition: template
    value_template: "{{ trigger.to_state.state not in ['unavailable', 'unknown', 'none', ''] }}"

action:
  - variables:
      sender: "{{ state_attr(sms_entity, 'sender') | default('æœªçŸ¥') }}"
      message: "{{ state_attr(sms_entity, 'message') | default(states(sms_entity)) }}"
      # æå–4-8ä½æ•°å­—éªŒè¯ç 
      code: >-
        {% set msg = message %}
        {% set ns = namespace(code='') %}
        {% set patterns = ['éªŒè¯ç ', 'æ ¡éªŒç ', 'åŠ¨æ€ç ', 'code', 'CODE', 'ç '] %}
        {% for pattern in patterns %}
          {% if pattern in msg and ns.code == '' %}
            {% set matches = msg | regex_findall('[0-9]{4,8}') %}
            {% if matches %}
              {% set ns.code = matches[0] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ ns.code }}
  
  - choose:
      # å¦‚æœæå–åˆ°éªŒè¯ç ï¼Œå‘é€ç®€æ´é€šçŸ¥
      - conditions:
          - condition: template
            value_template: "{{ code != '' }}"
        sequence:
          - service: !input notify_service
            data:
              title: "ğŸ”‘ éªŒè¯ç : {{ code }}"
              message: "æ¥è‡ª {{ sender }}"
              data:
                push:
                  sound: default
                tag: "sms_code_{{ sender }}"
    
    # å¦åˆ™å‘é€åŸå§‹çŸ­ä¿¡
    default:
      - service: !input notify_service
        data:
          title: "ğŸ“± {{ sender }}"
          message: "{{ message }}"
          data:
            push:
              sound: default
            tag: "sms_{{ sender }}"

mode: queued
max: 10
